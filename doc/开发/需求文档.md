# 自动静默部署系统 - 需求文档

## 1. 项目概述

实现一个模块化的服务器环境自动静默部署脚本，面向 Debian 12 系统，支持编译方式和快速部署两种模式。

---

## 2. 核心需求

### 2.1 启动入口

- 入口文件：`install.sh`
- 调用方式：`./install.sh --mysql --redis --php --openresty`
- 通过命令行参数控制安装哪些组件

### 2.2 预检机制

在执行安装前必须检查：

| 检查项 | 说明 |
|--------|------|
| root 权限 | 必须以 root 用户执行 |
| 系统版本 | 当前仅支持 Debian 12，后续可扩展其他系统 |
| Python3 环境 | 检查是否存在 python3 且版本 ≥ 3.8 |

预检失败时：输出明确错误信息并退出，不执行任何安装操作。

### 2.3 部署模式

| 模式 | 说明 |
|------|------|
| `--mode compile` | 编译方式安装（如从源码编译 OpenResty） |
| `--mode fast` | 快速部署（使用预编译包或已有二进制） |

### 2.4 组件模块化

每个组件独立，可单独安装：

- `system` - 基础系统设置（时区、目录、resolv.conf）
- `network` - 网络优化（BBR、sysctl 参数）
- `packages` - 基础软件包安装
- `php` - PHP-FPM 安装与配置
- `openresty` - OpenResty/Nginx 安装
- `mysql` - MySQL 安装（含自动生成密码）
- `redis` - Redis 安装与配置
- `fail2ban` - Fail2ban 安装与配置
- `firewall` - iptables 规则配置

### 2.5 错误隔离

**关键要求**：单个组件安装失败不影响其他组件继续安装。

- 每个组件独立执行
- 失败时记录错误但继续执行下一个组件
- 最终汇总所有组件的执行结果

### 2.6 静默执行

- 全程无交互，自动应答所有提示
- 设置 `DEBIAN_FRONTEND=noninteractive`
- apt 命令使用 `-y` 参数

---

## 3. 错误检测与报告

### 3.1 组件健康检查

每个组件安装后执行检查：

- 服务状态（systemctl is-active）
- 版本验证（mysql --version, php -v 等）
- 端口监听（ss -ltnp）
- 关键文件存在性

### 3.2 最终报告

安装完成后生成汇总报告，包含：

- 各组件执行状态（成功/失败）
- 失败原因
- 执行时长
- 日志文件路径

---

## 4. 可扩展性

### 4.1 多系统支持（预留）

- 当前：Debian 12
- 未来可扩展：Ubuntu、CentOS、Rocky Linux 等
- 通过 OS 适配层抽象包管理和服务管理差异

### 4.2 可选功能

- `--parallel` 并行安装组件
- `--retry N` 失败重试次数
- `--dry-run` 只检查不执行
- `--only-check` 只运行健康检查

---

## 5. 技术选型

| 层级 | 技术 | 说明 |
|------|------|------|
| 启动入口 | Bash | install.sh 做预检和参数解析 |
| 核心逻辑 | Python 3 | 组件化部署、日志、报告 |
| 配置管理 | YAML | components.yml 定义组件配置 |

---

## 6. 退出码规范

| 退出码 | 含义 |
|--------|------|
| 0 | 全部成功 |
| 2 | 参数/用法错误 |
| 3 | 预检失败 |
| 4 | 部分组件安装失败 |

---

## 7. 待确认事项

- [ ] 是否需要组件依赖关系（如 openresty 依赖 build 工具）
- [ ] 失败时是否支持回滚
- [ ] 是否需要远程上报安装结果
- [ ] 日志保留策略（保留多少天）
