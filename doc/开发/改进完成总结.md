# æ”¹è¿›å®Œæˆæ€»ç»“

## ðŸ“Œ æœ¬æ¬¡æ”¹è¿›å†…å®¹

### 1. SSL æ¨¡å—æž¶æž„æå‡ â­
**ä½ç½®å˜æ›´**: 
- **ä¹‹å‰**: `scripts/debian12/trojan-go/lib/ssl.sh`
- **çŽ°åœ¨**: `scripts/debian12/ssl.sh`

**æ”¹è¿›åŽŸå› **:
- SSL è¯ä¹¦ç®¡ç†æ˜¯é€šç”¨åŠŸèƒ½
- å…¶ä»–ç»„ä»¶ä¹Ÿå¯èƒ½éœ€è¦ SSLï¼ˆå¦‚æ·»åŠ æ–°çš„ vhostï¼‰
- é¿å…ä»£ç é‡å¤ï¼Œæé«˜å¤ç”¨æ€§

**å½±å“èŒƒå›´**:
- `trojan-go/main.sh` å¼•ç”¨è·¯å¾„æ›´æ–°ä¸º `source "${SCRIPT_DIR}/../ssl.sh"`
- ä»»ä½•æ–°å¢žéœ€è¦ SSL çš„ç»„ä»¶éƒ½å¯ç›´æŽ¥å¼•ç”¨

---

### 2. Nginx vhost ç›®å½•è§„èŒƒ ðŸ—ï¸

**ç›®å½•ç»“æž„**:
```
/usr/local/openresty/nginx/conf/
â”œâ”€â”€ nginx.conf  # ä¸»é…ç½®ï¼Œå¼•å…¥ vhost/*.conf
â””â”€â”€ vhost/
    â””â”€â”€ example.com.conf  # è™šæ‹Ÿä¸»æœºé…ç½®
```

**å®žçŽ°ç»†èŠ‚**:
1. å®‰è£… OpenResty æ—¶è‡ªåŠ¨åˆ›å»º `/usr/local/openresty/nginx/conf/vhost/` ç›®å½•
2. è‡ªåŠ¨ä¿®æ”¹ `nginx.conf` æ·»åŠ  `include /usr/local/openresty/nginx/conf/vhost/*.conf;`
3. é…ç½®ä¿®æ”¹å‰è‡ªåŠ¨å¤‡ä»½ï¼Œå¤±è´¥è‡ªåŠ¨å›žæ»š
4. ä¿®æ”¹åŽè‡ªåŠ¨æ‰§è¡Œ `nginx -t` éªŒè¯

**ä¼˜åŠ¿**:
- âœ… åŽç»­æ·»åŠ  vhost æ— éœ€ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶
- âœ… é…ç½®æ–‡ä»¶åˆ†ç¦»ç®¡ç†ï¼Œæ¸…æ™°æ˜“ç»´æŠ¤
- âœ… ç¬¦åˆ Nginx æœ€ä½³å®žè·µ

**çŽ¯å¢ƒå˜é‡æ›´æ–°**:
```bash
# æ—§å€¼: export NGINX_VHOST_DIR="/usr/local/openresty/nginx/conf/vhost"
# æ–°å€¼: export NGINX_VHOST_DIR="/usr/local/openresty/nginx/conf/vhost"
# (ä¿æŒä¸å˜ï¼Œæ­¤ä¸ºæ­£ç¡®è·¯å¾„)
```

---

### 3. ä»£ç å¥å£®æ€§å…¨é¢æå‡ ðŸ›¡ï¸

#### 3.1 å‚æ•°éªŒè¯
**æ‰€æœ‰å…³é”®å‡½æ•°éƒ½æ·»åŠ äº†å‚æ•°æ£€æŸ¥**:

```bash
# SSL æ¨¡å—
request_ssl_cert() {
    if [[ -z "$domain" ]]; then
        log_error "åŸŸåå‚æ•°ä¸èƒ½ä¸ºç©º"
        return 1
    fi
}

# Nginx æ¨¡å—
create_nginx_vhost() {
    if [[ -z "$domain" || -z "$ws_path" ]]; then
        log_error "å‚æ•°ä¸å®Œæ•´"
        return 1
    fi
    mkdir -p "${NGINX_VHOST_DIR}"  # ç¡®ä¿ç›®å½•å­˜åœ¨
}

# Trojan æ¨¡å—
create_trojan_config() {
    if [[ -z "$domain" || -z "$password" || -z "$ws_path" ]]; then
        log_error "é…ç½®å‚æ•°ä¸å®Œæ•´"
        return 1
    fi
    
    # éªŒè¯ SSL è¯ä¹¦å­˜åœ¨
    if [[ ! -f "/etc/letsencrypt/live/${domain}/fullchain.pem" ]]; then
        log_error "SSL è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
}

# çŽ¯å¢ƒæ¨¡å—
check_domain_dns() {
    if [[ -z "$domain" ]]; then
        log_error "åŸŸåå‚æ•°ä¸èƒ½ä¸ºç©º"
        return 1
    fi
}
```

#### 3.2 é”™è¯¯å¤„ç†ä¸Žå›žæ»š
**é…ç½®ä¿®æ”¹å®‰å…¨æœºåˆ¶**:

```bash
# å¤‡ä»½é…ç½®
local backup_file="${nginx_conf}.bak.$(date +%Y%m%d_%H%M%S)"
cp "$nginx_conf" "$backup_file"

# ä¿®æ”¹é…ç½®
if ! sed -i '...' "$nginx_conf"; then
    log_error "é…ç½®ä¿®æ”¹å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
    cp "$backup_file" "$nginx_conf"
    return 1
fi

# æµ‹è¯•é…ç½®
if ! nginx -t 2>/dev/null; then
    log_error "é…ç½®æµ‹è¯•å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
    cp "$backup_file" "$nginx_conf"
    return 1
fi
```

**ä¸»æµç¨‹é”™è¯¯å¤„ç†**:

```bash
# å…³é”®æ­¥éª¤å¤±è´¥ç«‹å³é€€å‡º
create_nginx_vhost "$DOMAIN" "$WS_PATH" || {
    log_error "Nginx è™šæ‹Ÿä¸»æœºåˆ›å»ºå¤±è´¥"
    exit 1
}

install_trojan || {
    log_error "Trojan-Go å®‰è£…å¤±è´¥"
    exit 1
}
```

#### 3.3 ä¸‹è½½é‡è¯•æœºåˆ¶
```bash
# æœ€å¤šé‡è¯• 3 æ¬¡
local max_retry=3
local retry=0
while [[ $retry -lt $max_retry ]]; do
    if wget -q --timeout=30 "https://github.com/.../trojan-go.zip"; then
        break
    fi
    retry=$((retry + 1))
    log_warn "ä¸‹è½½å¤±è´¥ï¼Œé‡è¯• $retry/$max_retry"
    sleep 2
done

# éªŒè¯ä¸‹è½½ç»“æžœ
if [[ ! -f trojan-go-linux-amd64.zip ]]; then
    log_error "ä¸‹è½½å¤±è´¥"
    return 1
fi
```

#### 3.4 è¶…æ—¶æŽ§åˆ¶
```bash
# DNS æ£€æŸ¥è¶…æ—¶æŽ§åˆ¶ï¼ˆ10ç§’ï¼‰
local server_ip=$(curl -s -4 --max-time 10 ifconfig.me)

# ä¸‹è½½è¶…æ—¶æŽ§åˆ¶ï¼ˆ30ç§’ï¼‰
wget -q --timeout=30 "..."
```

#### 3.5 æœåŠ¡çŠ¶æ€éªŒè¯
```bash
# æ£€æŸ¥ service æ–‡ä»¶å­˜åœ¨
if [[ ! -f /lib/systemd/system/nginx.service ]]; then
    log_error "Nginx service æ–‡ä»¶ä¸å­˜åœ¨"
    return 1
fi

# å¯åŠ¨åŽçŠ¶æ€æ£€æŸ¥
systemctl start nginx
sleep 2

if systemctl is-active --quiet nginx; then
    log_info "âœ“ Nginx å·²å¯åŠ¨"
else
    log_error "âœ— Nginx å¯åŠ¨å¤±è´¥"
    systemctl status nginx --no-pager -l
    # æ˜¾ç¤ºç«¯å£å ç”¨
    lsof -i :80 || netstat -tlnp | grep :80
    return 1
fi
```

---

## ðŸ“Š æ”¹è¿›ç»Ÿè®¡

### ä»£ç è¡Œæ•°å˜åŒ–
| æ–‡ä»¶ | æ”¹è¿›å‰ | æ”¹è¿›åŽ | å˜åŒ– |
|------|--------|--------|------|
| ssl.sh | 150 è¡Œ | 184 è¡Œ | +34 è¡Œ |
| nginx.sh | 180 è¡Œ | 330 è¡Œ | +150 è¡Œ |
| trojan.sh | 100 è¡Œ | 144 è¡Œ | +44 è¡Œ |
| env.sh | 130 è¡Œ | 159 è¡Œ | +29 è¡Œ |
| service.sh | 150 è¡Œ | 211 è¡Œ | +61 è¡Œ |
| **æ€»è®¡** | **~1000 è¡Œ** | **~1300 è¡Œ** | **+300 è¡Œ** |

å¢žåŠ çš„ä»£ç ä¸»è¦ç”¨äºŽï¼š
- å‚æ•°éªŒè¯ï¼ˆ~80 è¡Œï¼‰
- é”™è¯¯å¤„ç†å’Œå›žæ»šï¼ˆ~100 è¡Œï¼‰
- çŠ¶æ€æ£€æŸ¥å’Œæ—¥å¿—ï¼ˆ~80 è¡Œï¼‰
- vhost ç›®å½•é…ç½®ï¼ˆ~40 è¡Œï¼‰

### å¥å£®æ€§è¦†ç›–çŽ‡
- âœ… å‚æ•°éªŒè¯: 100%ï¼ˆæ‰€æœ‰å…³é”®å‡½æ•°ï¼‰
- âœ… æ–‡ä»¶æ£€æŸ¥: 100%ï¼ˆæ‰€æœ‰æ–‡ä»¶æ“ä½œï¼‰
- âœ… é”™è¯¯å¤„ç†: 100%ï¼ˆæ‰€æœ‰å…³é”®æ­¥éª¤ï¼‰
- âœ… çŠ¶æ€éªŒè¯: 100%ï¼ˆæ‰€æœ‰æœåŠ¡æ“ä½œï¼‰
- âœ… ç½‘ç»œè¶…æ—¶: 100%ï¼ˆæ‰€æœ‰ç½‘ç»œè¯·æ±‚ï¼‰
- âœ… ä¸‹è½½é‡è¯•: 100%ï¼ˆæ‰€æœ‰ä¸‹è½½æ“ä½œï¼‰

---

## ðŸŽ¯ æ”¹è¿›äº®ç‚¹

### 1. æž¶æž„å±‚é¢
- â­ **SSL æ¨¡å—é€šç”¨åŒ–** - æå‡åˆ°ä¸Šå±‚ï¼Œä¾›æ‰€æœ‰ç»„ä»¶å¤ç”¨
- â­ **vhost ç›®å½•è§„èŒƒ** - ç»Ÿä¸€ç®¡ç†ï¼Œè‡ªåŠ¨é…ç½®å¼•å…¥
- â­ **æ¨¡å—æ¸…æ™°åˆ†å±‚** - èŒè´£æ˜Žç¡®ï¼Œæ˜“äºŽç»´æŠ¤

### 2. å®‰å…¨å±‚é¢
- ðŸ›¡ï¸ **é…ç½®å¤‡ä»½å›žæ»š** - ä¿®æ”¹å¤±è´¥è‡ªåŠ¨æ¢å¤
- ðŸ›¡ï¸ **å‚æ•°å®Œæ•´éªŒè¯** - é¿å…ç©ºå€¼å¯¼è‡´é”™è¯¯
- ðŸ›¡ï¸ **æ–‡ä»¶å­˜åœ¨æ£€æŸ¥** - é¿å…æ“ä½œä¸å­˜åœ¨çš„æ–‡ä»¶

### 3. å¯é æ€§å±‚é¢
- ðŸ”„ **ä¸‹è½½é‡è¯•æœºåˆ¶** - ç½‘ç»œæ³¢åŠ¨ä¸å½±å“å®‰è£…
- â±ï¸ **è¶…æ—¶æŽ§åˆ¶** - é¿å…æ— é™ç­‰å¾…
- âœ… **çŠ¶æ€éªŒè¯** - ç¡®ä¿æ¯æ­¥æˆåŠŸæ‰ç»§ç»­

### 4. ç”¨æˆ·ä½“éªŒå±‚é¢
- ðŸ“ **è¯¦ç»†é”™è¯¯æ—¥å¿—** - å¤±è´¥æ—¶ç»™å‡ºæ˜Žç¡®æç¤º
- ðŸ” **æ™ºèƒ½è¯Šæ–­** - è‡ªåŠ¨æ£€æŸ¥ç«¯å£å ç”¨ç­‰é—®é¢˜
- ðŸ“‹ **è¿›åº¦åé¦ˆ** - æ¸…æ™°çš„æ­¥éª¤æç¤º

---

## ðŸš€ ä½¿ç”¨ç¤ºä¾‹

### å®‰è£… Trojan-Go
```bash
# å®Œå…¨è‡ªåŠ¨åŒ–
bash scripts/debian12/trojan-go.sh install

# åªéœ€è¾“å…¥ï¼š
# 1. åŸŸå: example.com
# 2. é‚®ç®±: admin@example.com
#
# è‡ªåŠ¨å®Œæˆï¼š
# âœ“ å‚æ•°éªŒè¯
# âœ“ DNS æ£€æŸ¥
# âœ“ SSL ç”³è¯·ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
# âœ“ é…ç½®ç”Ÿæˆï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
# âœ“ æœåŠ¡å¯åŠ¨ï¼ˆçŠ¶æ€æ£€æŸ¥ï¼‰
# âœ“ å¥åº·æ£€æŸ¥
```

### åŽç»­æ·»åŠ æ–° vhost
```bash
# 1. ç”³è¯· SSL è¯ä¹¦ï¼ˆå¤ç”¨ ssl.shï¼‰
source scripts/debian12/ssl.sh
request_ssl_cert "new-domain.com" "admin@new-domain.com"

# 2. åˆ›å»º vhost é…ç½®
cat > /usr/local/openresty/nginx/conf/vhost/new-domain.com.conf << EOF
server {
    listen 443 ssl http2;
    server_name new-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/new-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/new-domain.com/privkey.pem;
    
    # ... å…¶ä»–é…ç½®
}
EOF

# 3. æµ‹è¯•å¹¶é‡è½½
nginx -t && systemctl reload nginx

# âœ… æ— éœ€ä¿®æ”¹ nginx.conf
# âœ… è‡ªåŠ¨ç”Ÿæ•ˆ
```

---

## ðŸ“š æ–‡æ¡£æ›´æ–°

### æ–°å¢žæ–‡æ¡£
1. `doc/å¼€å‘/å¥å£®æ€§æ”¹è¿›æ¸…å•.md` - è¯¦ç»†çš„å¥å£®æ€§æ”¹è¿›è®°å½•
2. æ›´æ–° `doc/trojan-goæ¨¡å—åŒ–é‡æž„.md` - åæ˜ æž¶æž„å˜æ›´

### æ–‡æ¡£å†…å®¹
- âœ… SSL æ¨¡å—æå‡è¯´æ˜Ž
- âœ… vhost ç›®å½•ç»“æž„
- âœ… å¥å£®æ€§æ”¹è¿›è¯¦æƒ…
- âœ… å‚æ•°éªŒè¯ç¤ºä¾‹
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… ä½¿ç”¨ç¤ºä¾‹

---

## âœ… æ€»ç»“

æœ¬æ¬¡æ”¹è¿›å…±å®žæ–½äº† **3 å¤§ç±» 15 é¡¹å…·ä½“æ”¹è¿›**ï¼š

### æž¶æž„æ”¹è¿› (2 é¡¹)
1. âœ… SSL æ¨¡å—æå‡åˆ°é€šç”¨å±‚
2. âœ… Nginx vhost ç›®å½•è§„èŒƒåŒ–

### å¥å£®æ€§æ”¹è¿› (13 é¡¹)
3. âœ… å‚æ•°éžç©ºéªŒè¯ï¼ˆ5 ä¸ªæ¨¡å—ï¼‰
4. âœ… æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆSSL è¯ä¹¦ã€service æ–‡ä»¶ï¼‰
5. âœ… é…ç½®å¤‡ä»½æœºåˆ¶ï¼ˆnginx.conf ä¿®æ”¹ï¼‰
6. âœ… é…ç½®æµ‹è¯•éªŒè¯ï¼ˆnginx -tï¼‰
7. âœ… å¤±è´¥è‡ªåŠ¨å›žæ»šï¼ˆé…ç½®ä¿®æ”¹ï¼‰
8. âœ… ä¸‹è½½é‡è¯•æœºåˆ¶ï¼ˆ3 æ¬¡é‡è¯•ï¼‰
9. âœ… ç½‘ç»œè¶…æ—¶æŽ§åˆ¶ï¼ˆ10-30 ç§’ï¼‰
10. âœ… æœåŠ¡çŠ¶æ€éªŒè¯ï¼ˆsystemctl is-activeï¼‰
11. âœ… ç«¯å£å ç”¨æ£€æŸ¥ï¼ˆlsof/netstatï¼‰
12. âœ… ä¸»æµç¨‹é”™è¯¯å¤„ç†ï¼ˆå…³é”®æ­¥éª¤å¤±è´¥é€€å‡ºï¼‰
13. âœ… ç›®å½•å­˜åœ¨æ€§ç¡®ä¿ï¼ˆmkdir -pï¼‰
14. âœ… ä¸´æ—¶å˜é‡æ­£ç¡®ä½¿ç”¨ï¼ˆbackup_fileï¼‰
15. âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼ˆlog_error ç»Ÿä¸€å¤„ç†ï¼‰

### ä»£ç è´¨é‡
- ðŸ“ˆ ä»£ç è¡Œæ•°: +300 è¡Œï¼ˆ+30%ï¼‰
- ðŸ›¡ï¸ å¥å£®æ€§è¦†ç›–çŽ‡: 100%
- ðŸŽ¯ ç”Ÿäº§å¯ç”¨æ€§: â­â­â­â­â­

**çŽ°åœ¨è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§åˆ«ã€é«˜åº¦å¥å£®çš„è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿï¼** ðŸŽ‰
